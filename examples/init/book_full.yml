id: book_full
schema: public
target: { table: book_full }
sources:
  - id: book
    tables:
      - { schema: public, table: book, columns: ["id"] }
    expression: $1 AS book
    identity: book.id
  - id: book_author
    tables:
      - { schema: public, table: book_author, columns: ["book_id"] }
    expression: $1 AS book_author
    identity: book_author.book_id
  - id: author
    tables: [{ schema: public, table: author, columns: ["id"] }]
    expression: $1 AS author
    dep: book_author
    join: author.id = book_author.author_id
columns: [id, title, author_names]
query: >
  SELECT
    b.id,
    b.title,
    a.names
  FROM
    $1 AS k (id)
    JOIN book AS b ON k.id = b.id
    CROSS JOIN LATERAL (
      SELECT coalesce(array_agg(a.name ORDER BY ba.ordinal), '{}') AS names
      FROM
        author AS a
        JOIN book_author AS ba ON a.id = ba.author_id
      WHERE b.id = ba.book_id
    ) AS a
